<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Offline GPS Tracker (WebSocket)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; background: lightgray; }
    #info {
      position: absolute; top: 20px; left: 100px;
      background: rgba(255,255,255,0.9);
      padding: 6px 12px; border-radius: 8px;
      font-family: sans-serif; z-index: 1000;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    #reloadBtn {
  	position: absolute;
  	top: 20px;
  	left: 260px;  /* positions it to the right of the info box */
  	background: rgba(255,255,255,0.9);
  	border: 1px solid #ccc;
  	border-radius: 6px;
  	padding: 6px 10px;
  	font-size: 14px;
  	cursor: pointer;
  	z-index: 1000;
  	font-family: sans-serif;
  	box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  	transition: background 0.2s;
    }
    #reloadBtn:hover {
  	background: #f0f0f0;
    }
    
    .leaflet-control-layers-toggle {
  	background-image: url('/static/icons/globe.png') !important;
  	background-size: 20px 20px;
  	background-repeat: no-repeat;
  	background-position: center;
  	width: 34px !important;
  	height: 34px !important;
    }	
  </style>
</head>
<body>
  <div id="info">Distance: 0.00 km</div>
  <button id="reloadBtn" title="Reload track from today's log">↻ Reload Track</button>
  <div id="map"></div>

  <script src="/static/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script type="module">
  const map = L.map('map', { center: [44.3, 15.2], zoom: 12 });
  const osm = L.tileLayer('/tiles_osm/{z}/{x}/{y}.png', { maxZoom: 19, attribution: "OSM" });
  const satellite = L.tileLayer('/tiles_satellite/{z}/{x}/{y}.png', { maxZoom: 19, attribution: "Satellite" });
  osm.addTo(map);
  L.control.layers({ "🌍 OSM": osm, "🛰 Satellite": satellite }).addTo(map);

  const markerIcon = L.icon({
    iconUrl: "/static/icons/marker-icon.png",
    shadowUrl: "/static/icons/marker-shadow.png",
    iconSize: [25, 41], iconAnchor: [12, 41],
    popupAnchor: [1, -34], shadowSize: [41, 41]
  });

  const marker = L.marker([44.3, 15.2], { icon: markerIcon }).addTo(map);

  // Custom control to show zoom level
  const zoomControl = L.control({ position: 'bottomright' });

  zoomControl.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'zoom-level-control');
    div.style.background = 'rgba(255,255,255,0.8)';
    div.style.padding = '4px 8px';
    div.style.borderRadius = '4px';
    div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
    div.style.fontFamily = 'sans-serif';
    div.style.fontSize = '14px';
    div.textContent = `Zoom: ${map.getZoom()}`;
    return div;
  };

  zoomControl.addTo(map);

  // Update the zoom display whenever the user zooms
  map.on('zoomend', () => {
    const div = document.querySelector('.zoom-level-control');
    if (div) div.textContent = `Zoom: ${map.getZoom()}`;
  });


  const track = [];
  const polyline = L.polyline(track, { color: 'green' }).addTo(map);

  let totalDistance = 0;

  const toRad = d => d * Math.PI / 180;
  const haversineKm = (a, b) => {
    const R = 6371;
    const dLat = toRad(b[0] - a[0]);
    const dLon = toRad(b[1] - a[1]);
    const lat1 = toRad(a[0]);
    const lat2 = toRad(b[0]);
    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
  };

  async function loadRawTrack() {
    const today = new Date().toISOString().split("T")[0];
    try {
      const res = await fetch(`/raw/${today}`);
      if (!res.ok) return;
      const points = await res.json();
      if (points.length === 0) return;

      track.length = 0;
      totalDistance = 0;
      for (const p of points) {
        const latLng = [p.lat, p.lon];
        if (track.length > 0) totalDistance += haversineKm(track[track.length - 1], latLng);
        track.push(latLng);
      }
      polyline.setLatLngs(track);
      marker.setLatLng(track[track.length - 1]);
      map.fitBounds(polyline.getBounds());
      document.getElementById("info").textContent = `Distance: ${totalDistance.toFixed(2)} km (reloaded from log)`;
    } catch (err) {
      console.error("Failed to load raw log:", err);
    }
  }

  // Load from log on first page load
  await loadRawTrack();

  // Manual reload button
  document.getElementById("reloadBtn").addEventListener("click", async () => {
    document.getElementById("reloadBtn").textContent = "⟳ Loading...";
    await loadRawTrack();
    document.getElementById("reloadBtn").textContent = "↻ Reload Track";
  });

  // Live WebSocket updates
  const socket = io();
  socket.on("gps", (gpsData) => {
    const latLng = [gpsData.lat, gpsData.lon];
    marker.setLatLng(latLng);
    map.panTo(latLng);
    if (track.length > 0) totalDistance += haversineKm(track[track.length - 1], latLng);
    track.push(latLng);
    polyline.setLatLngs(track);
    document.getElementById("info").textContent = `Distance: ${totalDistance.toFixed(2)} km`;
  });
  </script>
</body>
</html>

