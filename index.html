<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Offline GPS Tracker (WebSocket + Multi-Path + Waypoints)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/leaflet.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; background: lightgray; }

    /* info panels */

    /* Collapsible GPS Info Panel */
#gpsInfoContainer {
  position: absolute;
  bottom: 10px;
  left: 10px;
  z-index: 1000;
  font-family: sans-serif;
}

/* Toggle button */
#gpsToggleBtn {
  background: rgba(255,255,255,0.9);
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

/* Panel box */
#gpsInfoPanel {
  display: none; /* hidden by default */
  margin-top: 8px;
  background: rgba(255,255,255,0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.3);
  width: 260px;
  backdrop-filter: blur(3px);
}

/* GPS boxes inside panel */
.gpsBox {
  background: rgba(255,255,255,0.9);
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 13px;
  font-family: monospace;
  margin-bottom: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.gpsBox:last-child { margin-bottom: 0; }
.gpsBox .label { color: #333; margin-right: 4px; }
.gpsBox .warn { color: darkorange; }
.gpsBox .error { color: red; }

/* Buttons inside panel */
#reloadBtn {
  background: rgba(255,255,255,0.9);
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 13px;
  width: 100%;
  cursor: pointer;
  margin-bottom: 6px;
}

    /* markers and icons */
    .rotated-marker {
      transition: transform 0.25s linear, filter 0.25s linear;
      transform-origin: center center;
    }
    .glow-nofix { filter: drop-shadow(2px 2px 4px rgba(255,0,0,0.8)); }
    .glow-2dfix { filter: drop-shadow(2px 2px 4px rgba(255,165,0,0.8)); }
    .glow-3dfix { filter: drop-shadow(2px 2px 6px rgba(0,255,0,0.8)) drop-shadow(0 0 4px rgba(255,255,255,0.5)); }

    /* layer and path controls */
    .leaflet-control-layers-toggle {
      background-image: url('/static/icons/globe.png') !important;
      background-size: 20px 20px; background-repeat: no-repeat;
      background-position: center; width: 34px !important; height: 34px !important;
    }
    .leaflet-control-path, .leaflet-control-waypoint {
      background-color: rgba(255,255,255,0.9); width: 36px; height: 36px;
      border-radius: 4px; text-align: center; line-height: 34px;
      cursor: pointer; font-size: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3); margin-top: 4px;
    }
    .leaflet-control-path.active { background-color: #4CAF50; color: white; }
    .leaflet-control-waypoint:hover { background-color: #f8d7da; }

    .path-marker div {
      font-size: 20px; font-weight: bold; color: blue;
      text-align: center;
    }
    .crosshair-cursor { cursor: crosshair !important; }

    /* zoom indicator */
    .zoom-level-control {
      background: rgba(255,255,255,0.8);
      padding: 5px 8px; border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      font-family: sans-serif; font-size: 14px;
    }
  </style>
</head>

<body>
<div id="gpsInfoContainer">
  <button id="gpsToggleBtn">📡 GPS Info</button>
  <div id="gpsInfoPanel">
    <button id="reloadBtn" title="Reload track from today's log">↻ Reload Track</button>
    <div class="gpsBox" id="info_distance"><span class="label">Distance:</span> <span class="value"> 0.00 km</span></div>
    <div class="gpsBox"><span class="label">Lat:</span> <span id="lat" class="value">--</span></div>
    <div class="gpsBox"><span class="label">Lon:</span> <span id="lon" class="value">--</span></div>
    <div class="gpsBox"><span class="label">Speed:</span> <span id="speed" class="value">--</span> km/h</div>
    <div class="gpsBox"><span class="label">Bearing:</span> <span id="bearing" class="value">--</span>°</div>
    <div class="gpsBox"><span class="label">Fix:</span> <span id="fix" class="value warn">No Fix</span></div>
    <div class="gpsBox"><span class="label">Accuracy:</span> <span id="accuracy" class="value">--</span> m</div>
    <div class="gpsBox"><span class="label">Status:</span> <span id="status" class="value">--</span></div>
    <div class="gpsBox"><span class="label">Records:</span> <span id="recordCount" class="value">--</span></div>
    <div class="gpsBox"><span class="label">Satellites:</span> <span id="sats" class="value">--</span></div>
  </div>
</div>

  <div id="map"></div>

  <script src="/static/leaflet.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script type="module">
  const map = L.map('map', { center: [44.3, 15.2], zoom: 12 });
  const osm = L.tileLayer('/tiles_osm/{z}/{x}/{y}.png', { minZoom: 3, maxZoom: 19 });
  const dark = L.tileLayer('/tiles_dark/{z}/{x}/{y}.png', { minZoom: 3, maxZoom: 32 });
  const satellite = L.tileLayer('/tiles_satellite/{z}/{x}/{y}.png', { minZoom: 3, maxZoom: 19 });
  osm.addTo(map);
  L.control.layers({ "🌍 OSM": osm, "🌙 Dark": dark, "🛰 Satellite": satellite }).addTo(map);

  const markerIcon = L.icon({ iconUrl: "/static/icons/arrow-icon.svg", iconSize:[50,50], iconAnchor:[25,25] });
  const marker = L.marker([44.3,15.2], { icon: markerIcon }).addTo(map);

  let lastBearing = 0;
  function setMarkerRotation(marker, bearing) {
    lastBearing = bearing;
    const el = marker.getElement();
    if (!el) return;
    const transform = el.style.transform || "";
    const base = transform.replace(/rotate\(.+?\)/, "");
    el.style.transform = `${base} rotate(${bearing}deg)`;
    el.classList.add("rotated-marker");
  }

  // zoom indicator
  const zoomControl = L.control({ position: 'bottomright' });
  zoomControl.onAdd = map => {
    const div = L.DomUtil.create('div', 'zoom-level-control');
    div.textContent = `Zoom: ${map.getZoom()}`;
    return div;
  };
  zoomControl.addTo(map);
  map.on('zoomend', () => {
    document.querySelector('.zoom-level-control').textContent = `Zoom: ${map.getZoom()}`;
  });

  const track = [];
  const polyline = L.polyline(track, { color: 'green' }).addTo(map);
  let totalDistance = 0;

  const toRad = d => d * Math.PI / 180;
  const haversineKm = (a, b) => {
    const R = 6371;
    const dLat = toRad(b[0] - a[0]), dLon = toRad(b[1] - a[1]);
    const lat1 = toRad(a[0]), lat2 = toRad(b[0]);
    const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
  };

  async function loadRawTrack() {
    //const today = new Date().toISOString().split("T")[0];
    // Use local date instead of UTC to match your Postgres query
    const today = new Date().toLocaleDateString("en-CA"); // "YYYY-MM-DD"
    console.log(`[DEBUG] Fetching /raw/${today}`);

    const res = await fetch(`/raw/${today}`);
    if (!res.ok) {
    	console.warn("Failed to fetch track data");
    	return;
    }
    const points = await res.json();
    console.log(`[DEBUG] Loaded ${points.length} points`);

    if (!points.length) {
    	console.warn("No track points returned for today");
    	return;
    }

    track.length = 0;
    totalDistance = 0;

    for (const p of points) {
      const latLng = [p.lat, p.lon];
      if (track.length > 0) totalDistance += haversineKm(track[track.length - 1], latLng);
      track.push(latLng);
    }

    polyline.setLatLngs(track);
    if (!map.hasLayer(polyline)) polyline.addTo(map);

    if (track.length) {
      marker.setLatLng(track[track.length - 1]);
      if (track.length > 1)
      	map.fitBounds(polyline.getBounds(), { padding: [30, 30] });
    }

    // Update UI distance
    document.querySelector("#info_distance .value").textContent = `${totalDistance.toFixed(2)} km (reloaded)`;
  }

  document.getElementById("reloadBtn").addEventListener("click", loadRawTrack);
  await loadRawTrack();

  async function updateRecordCount() {
    const res = await fetch("/count/raw");
    if (res.ok) {
      const data = await res.json();
      document.getElementById("recordCount").textContent = data.count.toLocaleString();
    }
  }
  await updateRecordCount();

  // --- waypoint layer ---
  const waypointLayer = L.layerGroup().addTo(map);
  const redDot = L.divIcon({
    className: "waypoint-dot",
    html: '<div style="width:8px;height:8px;border-radius:50%;background:red;"></div>',
    iconSize: [8,8]
  });

  async function loadWaypoints() {
    try {
      const res = await fetch("/waypoints");
      if (!res.ok) return;
      const waypoints = await res.json();
      waypointLayer.clearLayers();
      for (const wp of waypoints) {
        L.marker([wp.lat, wp.lon], { icon: redDot })
          .addTo(waypointLayer)
          .bindTooltip(wp.name || `WP ${wp.id}`);
      }
    } catch (e) { console.error(e); }
  }
  await loadWaypoints();

  // --- Add Waypoint Control ---
  const WaypointControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: () => {
      const div = L.DomUtil.create('div', 'leaflet-control-waypoint');
      div.innerHTML = '📍';
      div.title = "Add waypoint at current location";
      div.onclick = async () => {
        const latText = document.getElementById("lat").textContent;
        const lonText = document.getElementById("lon").textContent;
        if (latText === "--" || lonText === "--") return alert("No valid GPS fix yet!");
        const lat = parseFloat(latText), lon = parseFloat(lonText);
        const name = "Waypoint";
        await fetch("/waypoints", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, lat, lon, description: null })
        });
        await loadWaypoints();
      };
      return div;
    }
  });
  map.addControl(new WaypointControl());

  // --- Multi-path control ---
  const PathControl = L.Control.extend({
    options: { position: 'topright' },
    onAdd: map => {
      const div = L.DomUtil.create('div', 'leaflet-control-path');
      div.innerHTML = '&#x1F4C8;';
      div.title = "Enable multi-path placement";
      L.DomEvent.on(div, 'click', e => {
        L.DomEvent.stopPropagation(e);
        pathMode = !pathMode;
        if (pathMode) clearPath();
        div.classList.toggle('active', pathMode);
        div.title = pathMode ? "Click map to place path points" : "Enable multi-path placement";
        map.getContainer().classList.toggle('crosshair-cursor', pathMode);
      });
      return div;
    }
  });
  map.addControl(new PathControl());

  let pathMode = false;
  let pathMarkers = [], pathLines = [];
  function clearPath() {
    pathMarkers.forEach(m => map.removeLayer(m));
    pathLines.forEach(l => map.removeLayer(l));
    pathMarkers = [];
    pathLines = [];
  }

  function bearingBetweenPoints(lat1, lon1, lat2, lon2) {
    const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
    const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
              Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
  }

  map.on('click', e => {
    if (!pathMode) return;
    const point = [e.latlng.lat, e.latlng.lng];
    const currentPos = track.length ? track[track.length - 1] : null;
    const prevPoint = pathMarkers.length
      ? [pathMarkers[pathMarkers.length - 1].getLatLng().lat,
         pathMarkers[pathMarkers.length - 1].getLatLng().lng]
      : currentPos;

    const bearing = prevPoint ? bearingBetweenPoints(prevPoint[0], prevPoint[1], point[0], point[1]) : 0;
    const distance = prevPoint ? haversineKm(prevPoint, point).toFixed(2) : 0;
    const latStr = point[0].toFixed(6);
    const lonStr = point[1].toFixed(6);

    const labelHTML = `
      <div style="font-size:14px;text-align:center;">
        <strong>${bearing.toFixed(0)}°</strong> ${distance} km<br>
        <span style="font-size:14px;color:blue;">${latStr}, ${lonStr}</span>
      </div>`;

    const m = L.marker(point, {
      icon: L.divIcon({
        className: 'path-marker',
        html: labelHTML,
        iconSize: [180, 180],
        iconAnchor: [40, 25],
      })
    }).addTo(map);

    pathMarkers.push(m);

    if (prevPoint) {
      const line = L.polyline([prevPoint, point], { color: 'blue', weight: 2, dashArray: '5,5' }).addTo(map);
      pathLines.push(line);
    }
  });

  map.on('contextmenu dblclick', () => {
    if (pathMode) {
      pathMode = false;
      map.getContainer().classList.remove('crosshair-cursor');
      document.querySelector('.leaflet-control-path').classList.remove('active');
    }
  });

  // --- live GPS socket ---
  const socket = io();
  socket.on("gps", gpsData => {
    const { lat, lon, speed, track: bearing, accuracy, fix_mode, status } = gpsData;
    if (!lat || !lon || isNaN(lat) || isNaN(lon)) return;

    const latLng = [lat, lon];
    const last = track[track.length - 1];

    if (!last || lat !== last[0] || lon !== last[1]) {
      if (last) totalDistance += haversineKm(last, latLng);
      track.push(latLng);
      polyline.setLatLngs(track);
    }

    marker.setLatLng(latLng);
    map.panTo(latLng);

    document.querySelector("#info_distance .value").textContent =
      `${totalDistance.toFixed(2)} km`;
    document.getElementById("lat").textContent = lat.toFixed(8);
    document.getElementById("lon").textContent = lon.toFixed(8);
    document.getElementById("speed").textContent = (speed * 3.6).toFixed(1);
    document.getElementById("bearing").textContent = bearing ? bearing.toFixed(1) : "--";
    document.getElementById("accuracy").textContent = accuracy ? accuracy.toFixed(1) : "--";

    const fixEl = document.getElementById("fix");
    if (fix_mode === 3) { fixEl.textContent = "3D Fix"; fixEl.className = "value"; }
    else if (fix_mode === 2) { fixEl.textContent = "2D Fix"; fixEl.className = "value warn"; }
    else { fixEl.textContent = "No Fix"; fixEl.className = "value error"; }

    // Update status text
    const statusEl = document.getElementById("status");
    if (status === 0 || status === null || status === undefined) {
    	statusEl.textContent = "Unknown";
  	statusEl.className = "value error";
    } else if (status === 1) {
  	statusEl.textContent = "Normal";
  	statusEl.className = "value warn";
    } else if (status === 2) {
  	statusEl.textContent = "DGPS/Enhanced";
  	statusEl.className = "value";
    } else if (status === 3) {
  	statusEl.textContent = "RTK Fixed";
  	statusEl.className = "value";
    } else if (status === 4) {
  	statusEl.textContent = "RTK Floating";
  	statusEl.className = "value";
    } else if (status === 5) {
  	statusEl.textContent = "DR";
  	statusEl.className = "value";
    } else if (status === 6) {
  	statusEl.textContent = "GNSSDR";
  	statusEl.className = "value";
    } else if (status === 7) {
  	statusEl.textContent = "Time/Surveyed";
  	statusEl.className = "value";
    } else if (status === 8) {
  	statusEl.textContent = "Simulated";
  	statusEl.className = "value";
    } else if (status === 9) {
  	statusEl.textContent = "P/Y";
  	statusEl.className = "value";
    } else {
  	statusEl.textContent = String(status);
  	statusEl.className = "value";
    }

    if (bearing && !isNaN(bearing)) setMarkerRotation(marker, bearing);

    const icon = marker.getElement();
    if (icon) {
      icon.classList.remove("glow-nofix","glow-2dfix","glow-3dfix");
      if (fix_mode === 3) icon.classList.add("glow-3dfix");
      else if (fix_mode === 2) icon.classList.add("glow-2dfix");
      else icon.classList.add("glow-nofix");
    }
  });

  socket.on("satellite_update", sat => {
    document.getElementById("sats").textContent = `${sat.used}/${sat.total}`;
  });

  socket.on("raw_count_update", updateRecordCount);

  // Toggle GPS info panel
  document.getElementById("gpsToggleBtn").addEventListener("click", () => {
    const panel = document.getElementById("gpsInfoPanel");
    panel.style.display =
      panel.style.display === "none" || !panel.style.display ? "block" : "none";
  });
</script>

</body>
</html>

