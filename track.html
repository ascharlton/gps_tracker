<!DOCTYPE html>
<html>
<head>
  <title>Track Viewer</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100%; }
    #info {
      position: absolute;
      top: 20px;
      left: 100px;
      background: rgba(255, 255, 255, 0.8);
      padding: 6px 12px;
      border-radius: 8px;
      font-family: sans-serif;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="info">Loading track...</div>
  <div id="map"></div>
  <script src="/static/leaflet.js"></script>
  <script>
    // --- Map setup ---
    const osm = L.tileLayer('/tiles_osm/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 19
    });

    const satellite = L.tileLayer('/tiles_satellite/{z}/{x}/{y}.png', {
      attribution: 'Source: Esri, Maxar, Earthstar Geographics',
      maxZoom: 19
    });

    const map = L.map('map', {
      center: [44.3, 15.2], // fallback
      zoom: 12,
      layers: [osm]
    });

    L.control.layers({ "OSM": osm, "Satellite": satellite }).addTo(map);

    const infoBox = document.getElementById("info");

    const customIcon = L.icon({
      iconUrl: "/static/icons/marker-icon.png",
      shadowUrl: "/static/icons/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    const trackLine = L.polyline([], { color: "blue" }).addTo(map);

    // --- Haversine distance ---
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // --- Load track ---
    async function loadTrack(date) {
      try {
        const res = await fetch(`/track/${date}`);
        if (!res.ok) {
          infoBox.textContent = `No track available for ${date}`;
          return;
        }
        const points = await res.json();
        if (points.length === 0) {
          infoBox.textContent = `No points recorded for ${date}`;
          return;
        }

        const latlngs = points.map(p => [p.lat, p.lon]);
        trackLine.setLatLngs(latlngs);
        map.fitBounds(trackLine.getBounds());

        // Add start/end markers
        const start = latlngs[0];
        const end = latlngs[latlngs.length - 1];
        L.marker(start, { icon: customIcon }).addTo(map).bindPopup("Start");
        L.marker(end, { icon: customIcon }).addTo(map).bindPopup("End");

        // Compute distance
        let dist = 0;
        for (let i = 1; i < latlngs.length; i++) {
          dist += haversineDistance(
            latlngs[i-1][0], latlngs[i-1][1],
            latlngs[i][0], latlngs[i][1]
          );
        }
        infoBox.textContent = `Track for ${date} — Distance: ${dist.toFixed(2)} km`;
      } catch (err) {
        console.error("Track load failed:", err);
        infoBox.textContent = "Error loading track";
      }
    }

    // --- Parse ?date=YYYY-MM-DD ---
    const params = new URLSearchParams(window.location.search);
    const date = params.get("date");
    if (date) {
      loadTrack(date);
    } else {
      infoBox.textContent = "No date specified. Use ?date=YYYY-MM-DD";
    }
  </script>
</body>
</html>

